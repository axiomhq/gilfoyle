name: Eval

concurrency:
  group: eval-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'SKILL.md'
      - 'SKILL.core.md'
      - 'personas/**'
      - 'scripts/**'
      - 'reference/**'
      - '.meta/**'
      - '.github/workflows/**'

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile
        working-directory: .meta
      - name: Typecheck
        working-directory: .meta
        run: bunx tsc --noEmit
      - name: Lint
        working-directory: .meta
        run: bunx biome lint .

  eval:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - harness: amp
            model: ''
          - harness: opencode
            model: xai/grok-4-1-fast
          - harness: opencode
            model: anthropic/claude-opus-4-6
          - harness: claude
            model: claude-opus-4-6
    env:
      AXIOM_TOKEN: ${{ secrets.AXIOM_TOKEN }}
      AXIOM_DATASET: gilfoyle-evals
      AXIOM_ORG_ID: axiom-play-qf1k
      AMP_API_KEY: ${{ secrets.AMP_API_KEY }}
      XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      EVAL_HARNESS: ${{ matrix.harness }}
      EVAL_MODEL: ${{ matrix.model }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile
        working-directory: .meta
      - name: Install OpenCode CLI
        if: matrix.harness == 'opencode'
        run: bun install -g opencode-ai
      - name: Run eval
        working-directory: .meta
        run: bunx axiom eval 2>&1 | tee eval-output.log
      - name: Check for failures
        working-directory: .meta
        if: always()
        run: |
          if grep -qE "^\s*Tests\s+.*failed" eval-output.log; then
            echo "::error::Eval had failures"
            grep -E "(Tests\s+.*failed|âœ– case)" eval-output.log
            exit 1
          fi
