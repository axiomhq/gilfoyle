name: Eval

on:
  push:
    branches: [main]
    paths:
      - 'SKILL.md'
      - 'SKILL.core.md'
      - 'personas/**'
      - 'scripts/**'
      - 'reference/**'
      - '.meta/**'

jobs:
  eval:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - harness: amp
            model: ''
          - harness: opencode
            model: xai/grok-4-1-fast
          - harness: opencode
            model: anthropic/claude-opus-4-6-20250514
    env:
      AXIOM_TOKEN: ${{ secrets.AXIOM_TOKEN }}
      AXIOM_DATASET: gilfoyle-evals
      AXIOM_ORG_ID: axiom-play-qf1k
      AMP_API_KEY: ${{ secrets.AMP_API_KEY }}
      XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      EVAL_HARNESS: ${{ matrix.harness }}
      EVAL_MODEL: ${{ matrix.model }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile
        working-directory: .meta
      - name: Install OpenCode CLI
        if: matrix.harness == 'opencode'
        run: npm install -g opencode-ai
      - name: Run eval
        working-directory: .meta
        run: npx axiom eval 2>&1 | tee eval-output.log
      - name: Check for failures
        working-directory: .meta
        if: always()
        run: |
          if grep -q "failed" eval-output.log; then
            echo "::error::Eval had failures"
            grep -E "(FAIL|failed|Error:)" eval-output.log
            exit 1
          fi
