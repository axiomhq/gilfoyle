#!/usr/bin/env bash
# Axiom APL query helper - reads query from stdin
#
# Usage: axiom-query <deployment> [--raw] <<< "query"
#
# Examples:
#   # Simple query
#   axiom-query prod <<< "['logs'] | take 5"
#
#   # Complex query (heredoc - no escaping needed)
#   axiom-query prod <<'APL'
#   ['logs']
#   | where ['kubernetes.labels.app'] == "my-service"
#   | where _time between (ago(1h) .. now())
#   | summarize count() by bin(_time, 1m)
#   APL
#
#   # From file
#   axiom-query prod < query.apl
#
#   # Raw JSON output
#   axiom-query prod --raw <<< "['logs'] | take 5"

set -euo pipefail

DEPLOYMENT="${1:-}"
RAW=""

if [[ -z "$DEPLOYMENT" ]]; then
  echo "Usage: axiom-query <deployment> [--raw] <<< 'query'" >&2
  exit 1
fi

if [[ "${2:-}" == "--raw" ]]; then
  RAW="--raw"
fi

if [[ -t 0 ]]; then
  echo "Error: No query provided. Pipe a query to stdin." >&2
  echo "" >&2
  echo "Examples:" >&2
  echo "  axiom-query $DEPLOYMENT <<< \"['logs'] | take 5\"" >&2
  echo "  axiom-query $DEPLOYMENT < query.apl" >&2
  exit 1
fi

APL=$(cat)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
APL_JSON=$(printf '%s' "$APL" | jq -Rs .)

"$SCRIPT_DIR/axiom-api" "$DEPLOYMENT" POST "/v1/datasets/_apl?format=tabular" "{\"apl\": $APL_JSON}" \
  | "$SCRIPT_DIR/axiom-query-fmt" $RAW
